FROM directus/directus:latest

USER root

# Update Alpine packages to fix OS-level vulnerabilities
RUN apk update && apk upgrade --no-cache

# If needing to update Node to a newer patch (tricky; may require manual installation)
# Example: Install Node via nvm (not recommended for production, but possible)
RUN apk add --no-cache curl bash \
    && curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash \
    && . /root/.nvm/nvm.sh \
    && nvm install 20.15  # Or desired version \
    && nvm use 20.15 \
    && nvm alias default 20.15 \
    && ln -sf /root/.nvm/versions/node/v20.15.1/bin/node /usr/local/bin/node \
    && ln -sf /root/.nvm/versions/node/v20.15.1/bin/npm /usr/local/bin/npm \
    && ln -sf /root/.nvm/versions/node/v20.15.1/bin/pnpm /usr/local/bin/pnpm

USER node  # Switch back to non-root if needed

CMD :; (node bin/directus.js database migrate:latest || true) && node bin/directus.js

RUN echo "http://dl-cdn.alpinelinux.org/alpine/edge/main" > /etc/apk/repositories && \
    echo "http://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
RUN apk update && apk upgrade --no-cache