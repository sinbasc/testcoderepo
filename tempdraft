FROM directus/directus:11.6.1

# Install system dependencies (try curl, fallback to wget)
USER root
RUN if command -v apt-get >/dev/null; then \
        apt-get update && \
        apt-get install -y curl && \
        rm -rf /var/lib/apt/lists/*; \
    elif command -v apk >/dev/null; then \
        apk add --no-cache curl; \
    else \
        apt-get update && \
        apt-get install -y wget && \
        rm -rf /var/lib/apt/lists/*; \
    fi

# Download the AWS RDS CA certificate (use curl if available, else wget)
RUN mkdir -p /app/certs && \
    if command -v curl >/dev/null; then \
        curl -o /app/certs/rds-combined-ca-bundle.pem https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem; \
    else \
        wget -O /app/certs/rds-combined-ca-bundle.pem https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem; \
    fi && \
    chmod 644 /app/certs/rds-combined-ca-bundle.pem

# Switch to the non-root user
USER node

# Set Directus port to 80
ENV PORT=80

# Expose the new port
EXPOSE 80

# Run bootstrap and start Directus
CMD ["/bin/sh", "-c", "npx directus bootstrap && npx directus start"]