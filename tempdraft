FROM directus/directus:latest

USER root

# Update OS packages
RUN apk update && apk upgrade --no-cache

# Install NVM and desired Node version
RUN apk add --no-cache curl bash \
    && curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash \
    && . /root/.nvm/nvm.sh \
    && nvm install 22.17.1 \
    && nvm use 22.17.1 \
    && nvm alias default 22.17.1 \
    && ln -sf /root/.nvm/versions/node/v22.17.1/bin/node /usr/local/bin/node \
    && ln -sf /root/.nvm/versions/node/v22.17.1/bin/npm /usr/local/bin/npm \
    && ln -sf /root/.nvm/versions/node/v22.17.1/bin/pnpm /usr/local/bin/pnpm \
    && node -v  # For build-time verification

USER node  # Switch back

CMD :; (node bin/directus.js database migrate:latest || true) && node bin/directus.js

RUN echo "http://dl-cdn.alpinelinux.org/alpine/edge/main" > /etc/apk/repositories && \
    echo "http://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
RUN apk update && apk upgrade --no-cache