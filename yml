service: cloud-management

provider:
  name: aws
  runtime: nodejs14.x
  stage: dev
  region: us-east-1

resources:
  Resources:
    # Logging for Bucket A
    BucketA:
      Type: 'AWS::S3::Bucket'
      Properties:
        BucketName: bucket-a  # Existing bucket to enable logging for
        LoggingConfiguration:
          DestinationBucketName: !Ref LoggingBucket  # Reference to logging-bucket
          LogFilePrefix: s3-logs/
        Tags:
          - Key: Environment
            Value: Production
          - Key: Project
            Value: YourProjectName

    # CloudFront Logging Configuration
    CloudFrontDistribution:
      Type: 'AWS::CloudFront::Distribution'
      Properties:
        DistributionConfig:
          Enabled: true
          Origins:
            - Id: S3Bucket
              DomainName: !GetAtt BucketA.DomainName
              S3OriginConfig:
                OriginAccessIdentity: !Ref OriginAccessIdentity
          DefaultCacheBehavior:
            TargetOriginId: S3Bucket
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
          Logging:
            Bucket: !Sub '${LoggingBucket}.s3.amazonaws.com'  # Reference to logging-bucket
            Prefix: cloudfront-logs/
        Tags:
          - Key: Environment
            Value: Production
          - Key: Project
            Value: YourProjectName

    # CloudTrail Trail for CloudFormation logs
    CloudTrailTrail:
      Type: 'AWS::CloudTrail::Trail'
      Properties:
        S3BucketName: !Ref LoggingBucket  # Reference to logging-bucket
        S3KeyPrefix: cloudtrail-logs/
        IncludeGlobalServiceEvents: true
        IsLogging: true
        Tags:
          - Key: Environment
            Value: Production
          - Key: Project
            Value: YourProjectName

    # Logging Bucket
    LoggingBucket:
      Type: 'AWS::S3::Bucket'
      Properties:
        BucketName: logging-bucket  # Central bucket for all logs
        Tags:
          - Key: Environment
            Value: Production
          - Key: Project
            Value: YourProjectName

    # Bucket Policy for Logging Bucket
    LoggingBucketPolicy:
      Type: 'AWS::S3::BucketPolicy'
      Properties:
        Bucket: !Ref LoggingBucket
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Sid: AllowCloudFrontAccess
              Effect: Allow
              Principal:
                Service: cloudfront.amazonaws.com
              Action: s3:PutObject
              Resource: !Sub '${LoggingBucket.Arn}/cloudfront-logs/*'
              Condition:
                StringEquals:
                  AWS:SourceArn: !Ref CloudFrontDistribution

            - Sid: AllowCloudTrailAccess
              Effect: Allow
              Principal:
                Service: cloudtrail.amazonaws.com
              Action: s3:PutObject
              Resource: !Sub '${LoggingBucket.Arn}/cloudtrail-logs/*'
              Condition:
                StringEquals:
                  aws:SourceAccount: !Ref AWS::AccountId

            - Sid: AllowS3Logging
              Effect: Allow
              Principal: '*'
              Action: s3:PutObject
              Resource: !Sub '${LoggingBucket.Arn}/s3-logs/*'
              Condition:
                StringEquals:
                  s3:x-amz-acl: bucket-owner-full-control

    # Origin Access Identity for CloudFront
    OriginAccessIdentity:
      Type: 'AWS::CloudFront::CloudFrontOriginAccessIdentity'
      Properties:
        CloudFrontOriginAccessIdentityConfig:
          Comment: "Access to S3 bucket from CloudFront"
