service: cloud-management

provider:
  name: aws
  runtime: nodejs14.x
  stage: dev
  region: us-east-1

resources:
  Resources:
    # Logging for Bucket A
    BucketA:
      Type: 'AWS::S3::Bucket'
      Properties:
        BucketName: bucket-a  # Existing bucket to enable logging for
        ObjectOwnership: BucketOwnerEnforced  # Enforce bucket owner
        LoggingConfiguration:
          DestinationBucketName: !Ref LoggingBucket  # Reference to logging-bucket
          LogFilePrefix: s3-logs/
        Tags:
          - Key: Environment
            Value: Production
          - Key: Project
            Value: YourProjectName

    # CloudFront Logging Configuration
    CloudFrontDistribution:
      Type: 'AWS::CloudFront::Distribution'
      Properties:
        DistributionConfig:
          Enabled: true
          Origins:
            - Id: S3Bucket
              DomainName: !GetAtt BucketA.DomainName
              S3OriginConfig:
                OriginAccessIdentity: !Ref OriginAccessIdentity
          DefaultCacheBehavior:
            TargetOriginId: S3Bucket
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
          Logging:
            Bucket: !Sub '${LoggingBucket}.s3.amazonaws.com'  # Reference to logging-bucket
            Prefix: cloudfront-logs/
        Tags:
          - Key: Environment
            Value: Production
          - Key: Project
            Value: YourProjectName

    # CloudTrail Trail for CloudFormation logs
    CloudTrailTrail:
      Type: 'AWS::CloudTrail::Trail'
      Properties:
        S3BucketName: !Ref LoggingBucket  # Reference to logging-bucket
        S3KeyPrefix: cloudtrail-logs/
        IncludeGlobalServiceEvents: true
        IsLogging: true
        Tags:
          - Key: Environment
            Value: Production
          - Key: Project
            Value: YourProjectName

    # Logging Bucket
    LoggingBucket:
      Type: 'AWS::S3::Bucket'
      Properties:
        BucketName: logging-bucket  # Central bucket for all logs
        AccessControl: LogDeliveryWrite
        Tags:
          - Key: Environment
            Value: Production
          - Key: Project
            Value: YourProjectName

    # Origin Access Identity for CloudFront
    OriginAccessIdentity:
      Type: 'AWS::CloudFront::CloudFrontOriginAccessIdentity'
      Properties:
        CloudFrontOriginAccessIdentityConfig:
          Comment: "Access to S3 bucket from CloudFront"
